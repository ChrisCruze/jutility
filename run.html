<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cruz Control</title>
    <link href="https://cruzco.site44.com/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cruzco.site44.com/font-awesome/css/font-awesome.css" rel="stylesheet">
    <link href="https://cruzco.site44.com/css/animate.css" rel="stylesheet">
    <link href="https://cruzco.site44.com/css/style.css" rel="stylesheet">
    <link href='https://cruzco.site44.com/lib/fullcalendar.min.css' rel='stylesheet' />
    <link href='https://cruzco.site44.com/lib/fullcalendar.print.min.css' rel='stylesheet' media='print' />
    <link href='https://cruzco.site44.com/lib/scheduler.min.css' rel='stylesheet' />
    <link href="https://cruzco.site44.com/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cruzco.site44.com/font-awesome/css/font-awesome.css" rel="stylesheet">
    <link href="https://cruzco.site44.com/css/plugins/iCheck/custom.css" rel="stylesheet">
    <link href="https://cruzco.site44.com/css/animate.css" rel="stylesheet">
    <link href="https://cruzco.site44.com/css/style.css" rel="stylesheet">
    <script src="https://cruzco.site44.com/js/jquery-3.1.1.min.js"></script>
    <script src="https://cruzco.site44.com/js/bootstrap.min.js"></script>
    <script src="https://cruzco.site44.com/js/plugins/metisMenu/jquery.metisMenu.js"></script>
    <script src="https://cruzco.site44.com/js/plugins/slimscroll/jquery.slimscroll.min.js"></script>
    <script src="https://cruzco.site44.com/js/inspinia.js"></script>
    <script src="https://cruzco.site44.com/js/plugins/pace/pace.min.js"></script>
    <script src="https://cruzco.site44.com/js/plugins/flot/jquery.flot.js"></script>
    <script src="https://cruzco.site44.com/js/plugins/flot/jquery.flot.tooltip.min.js"></script>
    <script src="https://cruzco.site44.com/js/plugins/flot/jquery.flot.resize.js"></script>
    <script src="https://cruzco.site44.com/js/plugins/chartJs/Chart.min.js"></script>
    <script src="https://cruzco.site44.com/js/plugins/peity/jquery.peity.min.js"></script>
    <script src='https://cruzco.site44.com/lib/moment.min.js'></script>
    <script src='https://cruzco.site44.com/lib/jquery.min.js'></script>
    <script src='https://cruzco.site44.com/lib/fullcalendar.min.js'></script>
    <script src='https://cruzco.site44.com/lib/scheduler.min.js'></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/v/bs/jszip-2.5.0/dt-1.10.16/af-2.2.2/b-1.5.1/b-colvis-1.5.1/b-flash-1.5.1/b-html5-1.5.1/b-print-1.5.1/cr-1.4.1/fc-3.2.4/fh-3.1.3/kt-2.3.2/r-2.2.1/rg-1.0.2/rr-1.2.3/sc-1.4.4/sl-1.2.5/datatables.min.css"/>
  </head>
  <body class="top-navigation">
    <div id="wrapper">
      <div id="page-wrapper" class="gray-bg">
        <div class="wrapper wrapper-content">
          <div class="container">
            <div class="row">
              <div class="col-lg-8">
                <div class="ibox float-e-margins">
                  <div class="ibox-title">
                    <h5>Run Log</h5>
                  </div>
                  <div class="ibox-content">
                    <form role="form" class="form-inline">
                      <div class="form-group">
                        <label for="exampleInputEmail2" class="sr-only">Calories</label>
                        <input placeholder="Calories" id="calories" class="form-control" type="text">
                      </div>
                      <div class="form-group">
                        <label for="exampleInputPassword2" class="sr-only">Minutes</label>
                        <input placeholder="Minutes" id="minutes" class="form-control" type="text">
                      </div>
                      <div class="form-group">
                        <label for="exampleInputPassword2" class="sr-only">Miles</label>
                        <input placeholder="Miles" id="miles" class="form-control" type="text">
                      </div>
                      <div class="form-group">
                        <label for="exampleInputPassword2" class="sr-only">Notes</label>
                        <input placeholder="Notes" id="notes" class="form-control" type="text">
                      </div>
                      <button class="btn btn-white" type="submit" id="run_submit">Submit</button>
                    </form>
                  </div>
                </div>
              </div>
            </div>
            <div class="row">
              <div class="col-lg-8">
                <div class="ibox float-e-margins">
                  <div class="ibox-title">
                    <h5>Run Log</h5>
                  </div>
                  <div class="ibox-content">
                    <canvas id="calories_chart"></canvas>
                  </div>
                </div>
              </div>
            </div>
            <div class="row">
              <div class="col-lg-8">
                <div class="ibox float-e-margins">
                  <div class="ibox-title">
                    <h5>Run Log</h5>
                  </div>
                  <div class="ibox-content">
                    <canvas id="miles_chart"></canvas>
                  </div>
                </div>
              </div>
            </div>
            <div class="row">
              <div class="col-lg-8">
                <div class="ibox float-e-margins">
                  <div class="ibox-title">
                    <h5>Run Log</h5>
                  </div>
                  <div class="ibox-content">
                    <canvas id="minutes_chart"></canvas>
                  </div>
                </div>
              </div>
            </div>
            <div class="row">
              <div class="col-lg-8">
                <div class="ibox float-e-margins">
                  <div class="ibox-title">
                    <h5>Speed</h5>
                  </div>
                  <div class="ibox-content">
                    <canvas id="minutes_per_mile_chart"></canvas>
                  </div>
                </div>
              </div>
            </div>
            <div class="row">
              <div class="col-lg-12">
                <div style="" class="ibox-content">
                  <div class="table-responsive" >
                    <div class="table-responsive" >
                      <table class="table table-striped table-bordered table-hover" id='run_table'>
                        <thead>
                        </thead>
                        <tbody>
                          <tr>
                          </tr>
                        </tbody>
                        <tfoot>
                        <tr><th></th><th></th></tr>
                        </tfoot>
                      </table>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <script src="https://cruzco.site44.com/js/jquery-3.1.1.min.js"></script>
    <script src="https://cruzco.site44.com/js/bootstrap.min.js"></script>
    <script src="https://cruzco.site44.com/js/plugins/metisMenu/jquery.metisMenu.js"></script>
    <script src="https://cruzco.site44.com/js/plugins/slimscroll/jquery.slimscroll.min.js"></script>
    <!-- jquery UI -->
    <script src="https://cruzco.site44.com/js/plugins/jquery-ui/jquery-ui.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/4.5.0/firebase.js"></script>
    <!-- Touch Punch - Touch Event Support for jQuery UI -->
    <script src="https://cruzco.site44.com/js/plugins/touchpunch/jquery.ui.touch-punch.min.js"></script>
    <!-- Custom and plugin javascript -->
    <script src="https://cruzco.site44.com/js/inspinia.js"></script>
    <script src="https://cruzco.site44.com/js/plugins/pace/pace.min.js"></script>
    <!-- iCheck -->
    <script src="https://cruzco.site44.com/js/plugins/iCheck/icheck.min.js"></script>
    <!-- Jvectormap -->
    <script src="https://cruzco.site44.com/js/plugins/jvectormap/jquery-jvectormap-2.0.2.min.js"></script>
    <script src="https://cruzco.site44.com/js/plugins/jvectormap/jquery-jvectormap-world-mill-en.js"></script>
    <!-- Flot -->
    <script src="https://cruzco.site44.com/js/plugins/flot/jquery.flot.js"></script>
    <script src="https://cruzco.site44.com/js/plugins/flot/jquery.flot.tooltip.min.js"></script>
    <script src="https://cruzco.site44.com/js/plugins/flot/jquery.flot.resize.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.19.1/moment.js"></script>
    <!-- Custom and plugin javascript -->
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.32/pdfmake.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.32/vfs_fonts.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/v/bs/jszip-2.5.0/dt-1.10.16/af-2.2.2/b-1.5.1/b-colvis-1.5.1/b-flash-1.5.1/b-html5-1.5.1/b-print-1.5.1/cr-1.4.1/fc-3.2.4/fh-3.1.3/kt-2.3.2/r-2.2.1/rg-1.0.2/rr-1.2.3/sc-1.4.4/sl-1.2.5/datatables.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/plug-ins/1.10.16/api/sum().js"></script>
    <!-- ChartJS-->
    <script charset="utf-8" src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/1.0.2/Chart.min.js" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/1.3.3/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.0/Chart.min.js"></script>
            <script src="jutility.js"></script>

    <script>
    //initiate firebase
    firebase.initializeApp({databaseURL: "https://shippy-ac235.firebaseio.com/"});
    var dbRef = firebase.database();
    var contactsRef = dbRef.ref('run_log');
    function line_chart_create(x_axis_labels,y_axis_values,chart_name){
    var lineData = {
    labels:x_axis_labels,
    datasets: [{label: chart_name,
    backgroundColor: 'rgba(26,179,148,0.5)',
    borderColor: "rgba(26,179,148,0.7)", pointBackgroundColor: "rgba(26,179,148,1)", pointBorderColor: "#fff", data:y_axis_values }]
    };
    var lineOptions = {
    responsive: true
    };
    var ctx = document.getElementById(chart_name).getContext("2d");
    new Chart(ctx, {type: 'bar', data: lineData, options:lineOptions});
    }
    function dates_range(){
    start_time = moment()
    hours_list = []
    for (i = 0; i < 200; i++) {
    next_time = start_time.clone()
    next_time.add(i*-1,'day')
    hours_list.push(next_time)
    }
    return hours_list
    }
    function array_filter_by_date_function(array,moment_date_object){
    function date_is_equal_function(item){
    item_time_stamp = item.time_stamp
    due_date_moment = new moment(item_time_stamp)
    //due_date_moment = due_date_moment.subtract(2,'hours')
    due_date_moment_date = due_date_moment.format("Y-MM-DD")
    moment_date_object_formatted = moment_date_object.format("Y-MM-DD")
    result =  moment_date_object_formatted == due_date_moment_date
    return result
    }
    filtered_array = array.filter(date_is_equal_function)
    return filtered_array
    }
    function aggregate_filtered_array(array){
    calories_total = 0
    minutes_total = 0
    miles_total = 0
    array.forEach(function(item,index){
    calories_total += parseFloat(item.calories)
    minutes_total += parseFloat(item.minutes )
    miles_total += parseFloat(item.miles)
    })
    D = {calories_total:calories_total,minutes_total:minutes_total,miles_total:miles_total}
    return D
    }
    function line_charts_generate(firebase_data,dates_list){
    console.log(firebase_data)
    dates_list = dates_range()
    calories_list = []
    minutes_list = []
    miles_list = []
    x_axis_list = []
    dates_list.forEach(function(item,index){
    var firebase_array = firebase_data.slice(0);
    filtered_array = array_filter_by_date_function(firebase_array,item)
    aggregate_dictionary = aggregate_filtered_array(filtered_array)
    calories_list.push(aggregate_dictionary.calories_total)
    minutes_list.push(aggregate_dictionary.minutes_total)
    miles_list.push(aggregate_dictionary.miles_total)
    date_format = item.format("Y-MM-DD")
    x_axis_list.push(date_format)
    })
    x_axis_list.reverse()
    calories_list.reverse()
    minutes_list.reverse()
    miles_list.reverse()
    minutes_per_mile_list = []
    miles_list.forEach(function(i,counter){
    mile_count = miles_list[counter]
    minute_count = minutes_list[counter]
    mile_per_minute = minute_count/mile_count//minute_count
    minutes_per_mile_list.push(mile_per_minute)
    })
    line_chart_create(x_axis_list,calories_list,'calories_chart')
    line_chart_create(x_axis_list,miles_list,'miles_chart')
    line_chart_create(x_axis_list,minutes_list,'minutes_chart')
    line_chart_create(x_axis_list,minutes_per_mile_list,'minutes_per_mile_chart')
    }
    //calories burned, minutes taken, miles run, time_stamp
    function firebase_pull(){
    array = []
    contactsRef.on("child_added", function(snap) {
    dictionary_obj = snap.val()
    array.push(dictionary_obj)
    });
    return array
    }
    $("#run_submit").click(function(event) {
    data_to_push = {'notes':$("#notes").val(),'calories':$("#calories").val(),'time_stamp':moment().format(),'minutes':$("#minutes").val(),'miles':$("#miles").val()};
    console.log(data_to_push)
    contactsRef.push(data_to_push)
    $("#notes").val("")
    $("#calories").val("")
    $("#minutes").val("")
    $("#miles").val("")
    });



    firebase_data = firebase_pull()
    minutes_total = 0
    miles_total = 0
    firebase_data.forEach(function(D){minutes_total = minutes_total + parseFloat(D.minutes)})
    firebase_data.forEach(function(D){miles_total = miles_total + parseFloat(D.miles)})






































    date_range_dates_list = dates_range()
    function load_chart(){
    line_charts_generate(firebase_data,date_range_dates_list)
        run_table(contactsRef,"#run_table")

    //load_data_table(firebase_data)
    }
    setTimeout(load_chart, 3000);
    </script>
  </body>
</html>