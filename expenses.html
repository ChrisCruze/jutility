<!doctype html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Expenses</title>
    <link href="https://cruz.site44.com/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cruz.site44.com/font-awesome/css/font-awesome.css" rel="stylesheet">
    <link href="https://cruz.site44.com/css/animate.css" rel="stylesheet">
    <link href="https://cruz.site44.com/css/plugins/bootstrap-markdown/bootstrap-markdown.min.css" rel="stylesheet">
    <link href='https://rawgit.com/vderm9/jutility/master/style.css' rel="stylesheet">
    <link href='https://cruz.site44.com/lib/fullcalendar.min.css' rel='stylesheet' />
    <link href='https://cruz.site44.com/lib/fullcalendar.print.min.css' rel='stylesheet' media='print' />
    <link href='https://cruz.site44.com/lib/scheduler.min.css' rel='stylesheet' />
    <link href='https://cdn.datatables.net/1.10.16/css/jquery.dataTables.min.css' rel='stylesheet' />
    <link href="https://cruz.site44.com/css/plugins/dataTables/datatables.min.css" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/v/bs/jszip-2.5.0/dt-1.10.16/af-2.2.2/b-1.5.1/b-colvis-1.5.1/b-flash-1.5.1/b-html5-1.5.1/b-print-1.5.1/cr-1.4.1/fc-3.2.4/fh-3.1.3/kt-2.3.2/r-2.2.1/rg-1.0.2/rr-1.2.3/sc-1.4.4/sl-1.2.5/datatables.min.css"/>
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/css/toastr.min.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.13.2/css/bootstrap-select.min.css">

    <link href="https://cruz.site44.com/css/plugins/daterangepicker/daterangepicker-bs3.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.17.0/codemirror.css" />
    <link rel="stylesheet" href="https://cdn.firebase.com/libs/firepad/1.4.0/firepad.css" />
    <link rel="stylesheet" href="https://unpkg.com/purecss@1.0.0/build/pure-min.css">
    <link rel="stylesheet" href="https://cdn.rawgit.com/vderm9/jutility/master/css/editor.dataTables.min.css">
    <link rel="stylesheet" href="https://cdn.rawgit.com/ChrisCruze/jutility/master/libs/jquery.dataTables.yadcf.css">
    <link rel="stylesheet" href="css/small_chat.css">


    <!--         <link href="http://cdnjs.cloudflare.com/ajax/libs/summernote/0.8.9/summernote.css" rel="stylesheet">
     -->        <link href="https://cruz.site44.com/css/plugins/summernote/summernote.css" rel="stylesheet">



    <!-- Mainly scripts -->
    <script src="https://cruz.site44.com/js/jquery-3.1.1.min.js"></script>
    <script src="https://cruz.site44.com/js/bootstrap.min.js"></script>
    <script src="https://cruz.site44.com/js/plugins/metisMenu/jquery.metisMenu.js"></script>
    <script src="https://cruz.site44.com/js/plugins/slimscroll/jquery.slimscroll.min.js"></script>
    <!-- Flot -->
    <script src="https://cruz.site44.com/js/plugins/flot/jquery.flot.js"></script>
    <script src="https://cruz.site44.com/js/plugins/flot/jquery.flot.tooltip.min.js"></script>
    <script src="https://cruz.site44.com/js/plugins/flot/jquery.flot.spline.js"></script>
    <script src="https://cruz.site44.com/js/plugins/flot/jquery.flot.resize.js"></script>
    <script src="https://cruz.site44.com/js/plugins/flot/jquery.flot.pie.js"></script>
    <script src="https://cruz.site44.com/js/plugins/flot/jquery.flot.symbol.js"></script>
    <script src="https://cruz.site44.com/js/plugins/flot/curvedLines.js"></script>
    <!-- Peity -->
    <script src="https://cruz.site44.com/js/plugins/peity/jquery.peity.min.js"></script>
    <script src="https://cruz.site44.com/js/demo/peity-demo.js"></script>
    <!-- Custom and plugin javascript -->
    <script src="https://cruz.site44.com/js/inspinia.js"></script>
    <script src="https://cruz.site44.com/js/plugins/pace/pace.min.js"></script>
    <!-- jQuery UI -->
    <script src="https://cruz.site44.com/js/plugins/jquery-ui/jquery-ui.min.js"></script>
    <!-- Jvectormap -->
    <script src="https://cruz.site44.com/js/plugins/jvectormap/jquery-jvectormap-2.0.2.min.js"></script>
    <script src="https://cruz.site44.com/js/plugins/jvectormap/jquery-jvectormap-world-mill-en.js"></script>
    <!-- Sparkline -->
    <script src="https://cruz.site44.com/js/plugins/sparkline/jquery.sparkline.min.js"></script>
    <!-- ChartJS-->
    <script src="https://cruz.site44.com/js/plugins/chartJs/Chart.min.js"></script>
    <!-- CodeMirror-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.17.0/codemirror.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.17.0/mode/javascript/javascript.js"></script>
    <!-- FirebaseJS-->

    <script src="http://cdnjs.cloudflare.com/ajax/libs/summernote/0.8.9/summernote.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.13.2/js/bootstrap-select.min.js"></script>

    <script src="https://www.gstatic.com/firebasejs/4.10.1/firebase.js"></script>
    <script>
        firebase.initializeApp({apiKey: "AIzaSyApJBfnH0j3TSugzEABiMFkI_tU_XXeGzg", authDomain: "shippy-ac235.firebaseapp.com", databaseURL: "https://shippy-ac235.firebaseio.com"});
    </script>
    <script src="https://cdn.firebase.com/libs/firebaseui/2.6.2/firebaseui.js"></script>
    <link type="text/css" rel="stylesheet" href="https://cdn.firebase.com/libs/firebaseui/2.6.2/firebaseui.css" />
    <!-- Bootstrap markdown -->
    <script src="https://cruz.site44.com/js/plugins/bootstrap-markdown/bootstrap-markdown.js"></script>
    <script src="https://cruz.site44.com/js/plugins/bootstrap-markdown/markdown.js"></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/showdown/1.8.6/showdown.min.js'></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>
    <script src='https://cruz.site44.com/lib/moment.min.js'></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/moment-duration-format/2.2.2/moment-duration-format.min.js
        '></script>
    <script src='http://isaaccambron.com/twix.js/twix.js/dist/twix.min.js'></script>
    <script src='https://cdn.datatables.net/1.10.16/js/jquery.dataTables.min.js'></script>
    <script src="https://cruz.site44.com/js/plugins/dataTables/datatables.min.js"></script>
    <script src="https://cruz.site44.com/js/plugins/fullcalendar/fullcalendar.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.32/pdfmake.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.32/vfs_fonts.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/v/bs/jszip-2.5.0/dt-1.10.16/af-2.2.2/b-1.5.1/b-colvis-1.5.1/b-flash-1.5.1/b-html5-1.5.1/b-print-1.5.1/cr-1.4.1/fc-3.2.4/fh-3.1.3/kt-2.3.2/r-2.2.1/rg-1.0.2/rr-1.2.3/sc-1.4.4/sl-1.2.5/datatables.min.js"></script>

    <!--         <script src="http://cdnjs.cloudflare.com/ajax/libs/summernote/0.8.9/summernote.js"></script>
     -->
    <script src="https://cruz.site44.com/plugins/summernote/summernote.min.js"></script>

    <script type="text/javascript" src="https://cdn.datatables.net/plug-ins/1.10.16/api/sum().js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/plug-ins/1.10.16/sorting/datetime-moment.js"></script>
    <script type="text/javascript" src="https://cdn.rawgit.com/vderm9/jutility/master/js/dataTables.editor.min.js"></script>
    <link href="https://cruz.site44.com/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cruz.site44.com/font-awesome/css/font-awesome.css" rel="stylesheet">
    <link href="https://cruz.site44.com/css/animate.css" rel="stylesheet">
    <link href="https://cruz.site44.com/css/style.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/js/toastr.min.js"></script>
    <script src="https://cdn.rawgit.com/ChrisCruze/jutility/master/libs/jquery.dataTables.yadcf.js"></script>
    <script src="https://cruz.site44.com/js/plugins/daterangepicker/daterangepicker.js"></script>
    <script src="https://rawgit.com/vderm9/jutility/master/jutility.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/webcomponentsjs/1.1.0/webcomponents-hi.js"></script>
    <!-- <script src="https://rawgit.com/ChrisCruze/jutility/master/jutility.js"></script>
    -->
    <script src="https://cruz.site44.com/js/plugins/daterangepicker/daterangepicker.js"></script>

    <script src="https://chriscross.site44.com/js/jutility.js"></script>
    <script src="https://chriscross.site44.com/js/firebase.js"></script>

    <script src="jutility.js"></script>
</head>
<body>
<div id="wrapper">
    <div class="gray-bg" id="page-wrapper">
        <div class="wrapper wrapper-content">
            <div id='main_content'>
                <div class="container">
                    <div class="row">
                        <div class="col-lg-12">
                            <div class="ibox">
                                <div class="ibox-title">
                                    <h5>Date Range Picker</h5>
                                    <div class="ibox-tools">
                                        <a class="collapse-link"><i class="fa fa-chevron-up"></i></a> <a class="dropdown-toggle" data-toggle="dropdown" href="#"><i class="fa fa-wrench"></i></a>
                                        <ul class="dropdown-menu dropdown-user">
                                            <li>
                                                <a href="#">Config option 1</a>
                                            </li>
                                            <li>
                                                <a href="#">Config option 2</a>
                                            </li>
                                        </ul><a class="close-link"><i class="fa fa-times"></i></a>
                                    </div>
                                </div>
                                <div class="ibox-content" id="daterange_selector_container">
                                <input id="daterange_picker" class="form-control" type="text" name="daterange" value="01/01/2015 - 01/31/2015" />

                                                                <input id="demo" class="form-control" type="text" name="daterange" />

                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-lg-12">
                            <div class="ibox float-e-margins">
                                <div class="ibox-title">
                                    <h5></h5>
                                </div>
                                <div class="ibox-content">
                                    <div class="chartjs_section" style="position:relative;margin:auto">
                                        <canvas id="horizontal_bar_chart_cost" style="display: block;" width="819"></canvas>
                                    </div>`
                                    <div class="chartjs_section" style="position:relative;margin:auto">
                                        <canvas id="horizontal_bar_chart" style="display: block;" width="819"></canvas>
                                    </div>`
                                    <table class="display nowrap" id="table" style="width:100%"></table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script>

    function chartjs_horizontal_data_create(labels, data) {
        data_config = {
            labels: labels,
            datasets: [{
                label: 'Dataset 1',
                backgroundColor: 'red',
                borderWidth: 1,
                data: data
            }]
        }
        return data_config
    }

    function chart_create_from_callback_array(callback_array) {
        result_dict = array_group_by_calculation_length(callback_array, 'vendor')
        labels = result_dict['keys']
        data_points = result_dict['values']

        chart_identifier = "horizontal_bar_chart"
        data = chartjs_horizontal_data_create(labels, data_points)
        options = chartjs_horizontal_bar_chart_options_example()
        chart_type = "horizontalBar"
        chartjs_determine_creation(chart_identifier, data, options, chart_type)
    }

    function chart_create_from_callback_array_cost(callback_array) {
        result_dict = array_group_by_calculation_sum(callback_array, 'vendor','cost')
        labels = result_dict['keys']
        data_points = result_dict['values']

        chart_identifier = "horizontal_bar_chart_cost"
        data = chartjs_horizontal_data_create(labels, data_points)
        options = chartjs_horizontal_bar_chart_options_example()
        chart_type = "horizontalBar"
        chartjs_determine_creation(chart_identifier, data, options, chart_type)
    }




    function callback_function() {
        callback_array = datatables_callback_array_from_this(this)
        chart_create_from_callback_array(callback_array)
        chart_create_from_callback_array_cost(callback_array)


    }

    var editor = new $.fn.dataTable.Editor({
        table: '#table',
        idSrc: 'dropbox_id',
        fields: [{
            label: 'name',
            name: 'name'
        }, {
                label: 'vendor',
                name: 'vendor'
            }
        ]
    });

    $('#table').DataTable({
        dom: '<"html5buttons"B>lTfgitp',
        data: [],
        columns: [
            {'data':'direct_media_link','visible':false,title:'direct_media_link'},
            {'data':'file_name',title:'file_name','visible':true,render:function(data, type, row, meta) {
                    return "<a target='_blank' href='" + row.dropbox_link + "'>" + data + "</a>"
                }},
            {'data':'cost',title:'cost','visible':true},
            {'data':'vendor',title:'vendor','visible':false},
            {'data':'category',title:'category','visible':false},
            {'data':'section','title':'section','visible':false},
            {'data':'type','title':'type','visible':false},
            {'data':'time_stamp',title:'time_stamp','visible':false,format:'date'},

            {'data':'dropbox_link',title:'dropbox_link','visible':false},
            {'data':'evernote_url',title:'evernote_url','visible':false},
            {'data':'time_created',title:'time_created','visible':true},
        ],
        select: true,
        drawCallback:callback_function,
        paging: false,
        scrollX: true,
        colReorder: true,
        autoWidth: true,
        buttons: datatables_config_buttons_create_base_editor(editor)
    })

    function cost_calculate_from_string(file_name){
        cost = file_name.split('-')[0]
        dollars = cost.split('.')[0]
        cents = cost.split('.')[1]
        dollars = parseFloat(dollars)||0
        cents = parseFloat(cents)||0
        cost_total = dollars + cents/100
        return cost_total

    }

    function cost_calculate_from_dictionary(update_dictionary){
        file_name = update_dictionary['file_name']
        cost = cost_calculate_from_string(file_name)//regex_number_from_string(file_name)
        return cost
    }

    function cost_update_from_dictionary(update_dictionary){
        update_dictionary['cost'] = cost_calculate_from_dictionary(update_dictionary)
        return update_dictionary
    }

    function firebase_snap_dictionary_convert(snap){
        update_dictionary = firebase_dictionary_from_snapshot(snap)
        update_dictionary = cost_update_from_dictionary(update_dictionary)
        update_dictionary = dictionary_check_keys_ensure(update_dictionary, ['vendor','category','section','type','time_stamp','time_created'])
        return update_dictionary
    }


    var dbRef = dbRef || firebase.database();
    
    firebase_reference = dbRef.ref('receipts')
    firebase_reference.limitToLast(100).on("child_added", function(snap) {
        update_dictionary = firebase_snap_dictionary_convert(snap)
        $("#table").DataTable().row.add(update_dictionary).draw(false);
    })
    firebase_reference.on("child_changed", function(snap) {
        firebase_id = firebase_id_get_from_child(snap)
        update_dictionary = firebase_snap_dictionary_convert(snap)
        datatables_row_update_based_on_identifier("#table",update_dictionary, 'firebase_id', firebase_id)
    })


    function editor_create_function(D){
        console.log({D:D})
    }


    function editor_update_function(D) {
        firebase_id = D['firebase_id']
        r = firebase_reference.child(firebase_id).set(D);
        console.log({r:r})
    }






    datatables_editor_function_actions_apply(editor, editor_create_function, editor_update_function, editor_create_function)


    datatables_column_filter_initiate("#table")


    // function daterange_func(start,end,label){
    //     console.log({start:start,end:end,r:r})
    //     $("#table").DataTable().draw()

    // }
    // daterangepicker_literal_append_with_function('01/01/2018 - 01/31/2019', "#daterange_selector_container", daterange_func) 










daterangepicker_datatables_filter_initiate("#table","#demo",'time_created')







// $('#daterange_picker').daterangepicker();
// $('#daterange_picker').on('apply.daterangepicker', function(ev, picker) {
//   console.log(picker.startDate.format('YYYY-MM-DD'));
//   console.log(picker.endDate.format('YYYY-MM-DD'));
// });



//daterangepicker_callback("#daterange_picker","#table")


</script>
</body>
</html>